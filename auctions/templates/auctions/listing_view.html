{% extends "auctions/layout.html" %}

{% block body %}

    {% if listing %}
        <h2>Listing: {{ listing.title }}</h2>

        {% if request.user.is_authenticated %} 
            {% if not listing.closed %} 
                {% if not request.user == listing.user %} 
                    {% if not watching %}
                        <a href="{% url 'watch' listing.id %}">Start Watching</a>
                    {% elif watching %}
                        <a href="{% url 'unwatch' listing.id %}">Stop Watching</a>
                    {% endif %}
                {% else %} 
                        <a href="{% url 'close' listing.id %}">Close Auction</a>
                {% endif %}
            {% else %}
                {% if not request.user == listing.user %} 
                    <p>The Bidding has been closed.</p>
                    {% if highest_bid and request.user == highest_bid.user %}
                        <p style="color: green;">Yay, you won the bid!!!</p>
                    {% endif %}
                {% else %}
                    <p>The Bidding is now closed.</p>
                    {% if highest_bid  %}
                        <p> 
                            Name: {{ highest_bid.user }} <br >
                            Bid: ${{ highest_bid.bid }} <br />
                        </p>
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}

        <br />
        <br />

        {% if message %}
            <div>{{ message }}</div>
        {% endif %}
        {% for error in bidForm.non_field_errors %}
            <p style="color:red;">{{ error }}</p>
        {% endfor %}
        {% for error in commentForm.comment.errors %}
            <p style="color:red;">{{ error }}</p>
        {% endfor %}

        <div>
            <div>
                <img width="400" height="400" src="{{ listing.photo.url }}" alt="{{ listing.title }}"  />
            </div>
            <br />
            <div>
                </b><i>{{ listing.description }}</i><br/>
                <h6>{{ listing.startBid }}</h6>
            </div>
        </div>
        <br />
        <!-- The below lines of codes allows the user to place a bid if they have logged into the portal. -->
        {% if request.user.is_authenticated and not listing.closed and request.user != listing.user %}

            <div>
                <p>{{ listing.biddings.count }} bid(s) so far. Your bid is the current bid.</p>
            </div>
            <div>
                <form action="{% url 'place_bid' %}" method="post" >
                    {% csrf_token %}
                    <div class="form-group">
                        {{ bidForm.bid }}
                    </div>
                    <div class="form-group">
                        {{ bidForm.list_id }}
                    </div>
                    <input class="btn btn-primary" type="submit" value="Place Bid">
                </form>
            </div>

        {% endif %}
        <br />
        <br />
        <div>
            <div>
                <h6>Details</h6>
                <ul>
                    <li>Listed By: {{ listing.user }}</li>
                    <li>Category: {{ listing.categories }}</li>
                </ul>
            </div>
        </div>

        <br />
        <br />
        <div>
            <div>
                <h6>Comments</h6>
                
                <!-- The below line allows the user to comment on a listing item only if they are logged in -->
                {% if request.user.is_authenticated and not listing.closed and request.user != listing.user  %}
                    <div>
                        <form action="{% url 'add_comment' %}" method="post" >
                            {% csrf_token %}
                            <div class="form-group">
                                {{ commentForm.text }}
                            </div>
                            <div class="form-group">
                                {{ commentForm.list_id }}
                            </div>
                            <input class="btn btn-primary" type="submit" value="Add Comment">
                        </form>
                    </div>
                {% endif %}

                <!-- The below line lists out all comments associated with a listing. -->
                <div>
                    {% for comment in listing.comments.all %}

                        <br />
                            <p>
                                <b>User: {{comment.user}}</b><br />
                                <i>{{comment.text}}</i>
                            </p>
                        <br />
                        <hr />

                        {% empty %}
                            <p>No comments adding to this listing.</p>

                    {% endfor %}
                    
                </div>
            </div>
        </div>

    {% else %}
        <h2>Listing</h2>
        <p style="color: red;">There is no such listing in the system.</p>
    {% endif %}


{% endblock %}